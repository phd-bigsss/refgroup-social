---
title: "Data preparation - micro"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
      number_sections: yes
    code_folding: hide
    number_sections: yes
editor_options:
  chunk_output_type: console
---

# Setup

```{r setup}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
options(scipen=9999) # desactivar notacion cientifica
```

## Individual data

```{r}
remove(list = ls()) # clean workspace
if (!require("pacman")) install.packages("pacman") # install pacman
pacman::p_load(dplyr,readxl,sjmisc, sjlabelled, questionr, car,here,ggplot2)# load libraries
load(here::here("input/data/original/ELSOC_Long_2016_2022_v1.00.RData"))

elsoc_long_2016_2022.2[elsoc_long_2016_2022.2 ==-999] <- NA
elsoc_long_2016_2022.2[elsoc_long_2016_2022.2 ==-888] <- NA
elsoc_long_2016_2022.2[elsoc_long_2016_2022.2 ==-777] <- NA
elsoc_long_2016_2022.2[elsoc_long_2016_2022.2 ==-666] <- NA

# Attitudes____________________________________________________________________
elsoc_long_2016_2022.2 <- 
elsoc_long_2016_2022.2 %>% 
  #create new variables
  mutate(just_educ=d02_02,
         just_pension=d02_01,
         just_salud=d02_03,
         des_perc=c18_11,
         gensocialtrust=c02,
         genaltruism=c03,
         genjust=c04,
         prosocial1=c07_01,
         prosocial2=c07_02,
         prosocial3=c07_03,
         prosocial4=c07_04,
         prosocial5=c07_05,
         prosocial6=c07_06,
         prosocial7=c07_07,
         prosocial8=c07_08,
         sexo=m0_sexo) %>% 
  sjlabelled::drop_labels(., drop.na = FALSE)
  
sjmisc::frq(elsoc_long_2016_2022.2$just_educ)
elsoc_long_2016_2022.2$just_educ <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$just_educ, 
                      label = "Market-based access to Education")

#
elsoc_long_2016_2022.2$just_pension <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$just_pension, 
                      label = "Market-based access to Pensions")

#
elsoc_long_2016_2022.2$just_salud <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$just_salud, 
                      label = "Market-based access to Health")

for (i in c("just_educ", "just_pension", "just_salud")) {
elsoc_long_2016_2022.2[[i]] <-
sjlabelled::set_labels(x = elsoc_long_2016_2022.2[[i]],
                       labels = c("Strongly disagree","Disagree",
                                  "Neither disagree nor agree",
                                  "Agree", "Strongly agree"))
}


elsoc_long_2016_2022.2$percger <-  elsoc_long_2016_2022.2$d03_01+1
elsoc_long_2016_2022.2$percger <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$percger, label = "Perceived Salary: Manager")
elsoc_long_2016_2022.2$percgerlog <- log(elsoc_long_2016_2022.2$percger)
elsoc_long_2016_2022.2$percgerlog <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$percgerlog, label = "Perceived Salary: Manager (log)")
elsoc_long_2016_2022.2$percgerptile <- ntile(elsoc_long_2016_2022.2$percger,100)
elsoc_long_2016_2022.2$percgerptile <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$percgerptile, label = "Perceived Salary: Manager (ptiles)")

elsoc_long_2016_2022.2 %>% select(percgerlog,percgerptile,percger) %>% sjPlot::tab_corr(triangle = "lower")

elsoc_long_2016_2022.2$justger <-  elsoc_long_2016_2022.2$d04_01+1
elsoc_long_2016_2022.2$justger <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$justger, label = "Just Salary: Manager")
elsoc_long_2016_2022.2$justgerlog <- log(elsoc_long_2016_2022.2$justger)
elsoc_long_2016_2022.2$justgerlog <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$justgerlog, label = "Just Salary: Manager (log)")
elsoc_long_2016_2022.2$justgerptile <- ntile(elsoc_long_2016_2022.2$justger,100)
elsoc_long_2016_2022.2$justgerptile <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$justgerptile, label = "Just Salary: Manager (ptiles)")


elsoc_long_2016_2022.2 %>% select(justgerlog,justgerptile,justger) %>% sjPlot::tab_corr(triangle = "lower")


elsoc_long_2016_2022.2$percobr <-  elsoc_long_2016_2022.2$d03_02+1
elsoc_long_2016_2022.2$percobr <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$percobr, label = "Perceived Salary: Worker")
elsoc_long_2016_2022.2$percobrlog <- log(elsoc_long_2016_2022.2$percobr)
elsoc_long_2016_2022.2$percobrlog <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$percobrlog, label = "Perceived Salary: Worker (log)")
elsoc_long_2016_2022.2$percobrptile <- ntile(elsoc_long_2016_2022.2$percobr,100)
elsoc_long_2016_2022.2$percobrptile <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$percobrptile, label = "Perceived Salary: Worker (ptiles)")


elsoc_long_2016_2022.2 %>% select(percobr,percobrlog,percobrptile) %>% sjPlot::tab_corr(triangle = "lower")

elsoc_long_2016_2022.2$justobr <-  elsoc_long_2016_2022.2$d04_02+1
elsoc_long_2016_2022.2$justobr <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$justobr, label = "Just Salary: Worker")
elsoc_long_2016_2022.2$justobrlog <- sjlabelled::set_label(log(elsoc_long_2016_2022.2$justobr),"Just Salary: Worker (log)")
elsoc_long_2016_2022.2$justobrptile <- sjlabelled::set_label(ntile(elsoc_long_2016_2022.2$justobr,100),"Just Salary: Worker (ptiles)")

elsoc_long_2016_2022.2 %>% select(justobr,justobrlog,justobrptile) %>% sjPlot::tab_corr(triangle = "lower")

elsoc_long_2016_2022.2$percgap <-  elsoc_long_2016_2022.2$percger/elsoc_long_2016_2022.2$percobr
elsoc_long_2016_2022.2$percgap <-sjlabelled::set_label(x = elsoc_long_2016_2022.2$percgap, label = "Perceived Salary Gap")
elsoc_long_2016_2022.2$percgaplog <- sjlabelled::set_label(x = log(elsoc_long_2016_2022.2$percgap), label = "Perceived Salary Gap (log)")
elsoc_long_2016_2022.2$percgapptile <- sjlabelled::set_label(x = ntile(elsoc_long_2016_2022.2$percgap,100), label = "Perceived Salary Gap (ptiles)")

elsoc_long_2016_2022.2 %>% select(percgap,percgaplog,percgapptile) %>% sjPlot::tab_corr(triangle = "lower")

elsoc_long_2016_2022.2$justgap <-  elsoc_long_2016_2022.2$justger/elsoc_long_2016_2022.2$justobr
elsoc_long_2016_2022.2$justgap <- sjlabelled::set_label(x = elsoc_long_2016_2022.2$justgap, label = "Just Salary Gap")

elsoc_long_2016_2022.2$justgaplog <-  sjlabelled::set_label(x = log(elsoc_long_2016_2022.2$justgap), label = "Just Salary Gap (log)")
elsoc_long_2016_2022.2$justgapptile <-  sjlabelled::set_label(x = ntile(elsoc_long_2016_2022.2$justgap,100), label = "Just Salary Gap (ptiles)")
elsoc_long_2016_2022.2 %>% select(justgap,justgaplog,justgapptile) %>% sjPlot::tab_corr(triangle = "lower")

elsoc_long_2016_2022.2$prosocial1 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial1, 
                      label = "I visited a neighbor's house")

elsoc_long_2016_2022.2$prosocial2 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial2, 
                      label = "Attended a meeting on topics of public/community interest")

elsoc_long_2016_2022.2$prosocial3 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial3, 
                      label = "Friends have visisted their home")

elsoc_long_2016_2022.2$prosocial4 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial4, 
                      label = "Have done volunteer work")

elsoc_long_2016_2022.2$prosocial5 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial5, 
                      label = "Has donated money to charity")

elsoc_long_2016_2022.2$prosocial6 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial6, 
                      label = "Has lent $10,000 or more")


elsoc_long_2016_2022.2$prosocial7 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial7, 
                      label = "Talked to a person in trouble or depressed")

elsoc_long_2016_2022.2$prosocial8 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$prosocial8, 
                      label = "Helped someone get a job")


for (i in c("prosocial1","prosocial2","prosocial3","prosocial4","prosocial5",
            "prosocial6","prosocial7","prosocial8")) {
elsoc_long_2016_2022.2[[i]] <-
sjlabelled::set_labels(x = elsoc_long_2016_2022.2[[i]],
                       labels = c("Never did it","Did it once or twice","Did it more than twice"))
}


elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  sjmisc::frq(prosocial1) %>% 
  as.data.frame() %>% 
  select(variable, group, label,raw.prc) %>% 
  na.omit() %>% 
  ggplot(aes(fill=label, x=group, y=raw.prc, label = raw.prc)) +
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 4, position = position_stack(vjust = 0.5))

elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  sjmisc::frq(prosocial2) %>% 
  as.data.frame() %>% 
  select(variable, group, label,raw.prc) %>% 
  na.omit() %>% 
  ggplot(aes(fill=label, x=group, y=raw.prc, label = raw.prc)) +
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 4, position = position_stack(vjust = 0.5))


elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  sjmisc::frq(just_pension) %>% 
  as.data.frame() %>% 
  select(variable, group, label,raw.prc) %>% 
  mutate(label=factor(label,levels = rev(c("Strongly disagree","Disagree","Neither disagree nor agree","Agree", "Strongly agree")))) %>% 
  filter(group!=2021) %>% 
  na.omit() %>% 
  ggplot(aes(fill=label, x=group, y=raw.prc, label = raw.prc)) +
  geom_bar(position="stack", stat="identity") +
  labs(title = "It is just that people with higher incomes have better pensions than people with lower incomes.",x="Year",y="Percentage") +
  geom_text(size = 4, position = position_stack(vjust = 0.5))

elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  sjmisc::frq(just_educ) %>% 
  as.data.frame() %>% 
  select(variable, group, label,raw.prc) %>% 
  mutate(label=factor(label,levels = rev(c("Strongly disagree","Disagree","Neither disagree nor agree","Agree", "Strongly agree")))) %>% 
  na.omit() %>% 
  filter(group!=2021) %>% 
  ggplot(aes(fill=label, x=group, y=raw.prc, label = raw.prc)) +
  labs(title = "It is just that people with higher incomes have a better education for their children than people with lower incomes.",x="Year",y="Percentage") +
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 4, position = position_stack(vjust = 0.5))

elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  sjmisc::frq(just_salud) %>% 
  as.data.frame() %>% 
  select(variable, group, label,raw.prc) %>% 
  mutate(label=factor(label,levels = rev(c("Strongly disagree","Disagree","Neither disagree nor agree","Agree", "Strongly agree")))) %>% 
  na.omit() %>% 
  filter(group!=2021) %>% 
  ggplot(aes(fill=label, x=group, y=raw.prc, label = raw.prc)) +
  labs(title = "It is just that people with higher incomes can access better health care than people with lower incomes.",x="Year",y="Percentage")+
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 4, position = position_stack(vjust = 0.5))



library(ggrepel)
bind_rows(
elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(market=mean(just_pension,na.rm = T),
         field="Pensions"),

elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(market=mean(just_educ,na.rm = T),
         field="Education"),

elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(market=mean(just_salud,na.rm = T),
         field="Health")

) %>% na.omit() %>% 
  ggplot(aes(x=factor(ola),y = market, group=field, color=field)) +
  geom_point()+
  geom_line() +
  scale_y_continuous(limits = c(1,5),labels = c("Strongly disagree","Disagree","Neither disagree nor agree","Agree", "Strongly agree")) +
  scale_x_discrete(labels=c("2016","2017","2018","2019","2022")) +
  labs(title = "Market distribution to social services by year",x="Year",y=NULL)

```

## Networks 
```{r know}

# for the number of contacts for each occupation, the average value is used.

#"Conoce: Medico o doctor/a" 
sjmisc::frq(elsoc_long_2016_2022.2$r01_08)
elsoc_long_2016_2022.2$know_doctor <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_08,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_doctor)

#"Conoce: Gerente o director de gran empresa" (70)
sjmisc::frq(elsoc_long_2016_2022.2$r01_01)
elsoc_long_2016_2022.2$know_ceo <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_01,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_ceo)

elsoc_long_2016_2022.2$r01_06 #"Conoce: Abogado/a" (85)
sjmisc::frq(elsoc_long_2016_2022.2$r01_06)
elsoc_long_2016_2022.2$know_lawyer <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_06,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_lawyer)

#"Conoce: Profesor/a de universidad" (77)
sjmisc::frq(elsoc_long_2016_2022.2$r01_13)
elsoc_long_2016_2022.2$know_univprof <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_13,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_univprof)

# Middle status occupations-----------------------------------------------------

#"Conoce: Contador/a" (60)
sjmisc::frq(elsoc_long_2016_2022.2$r01_12)
elsoc_long_2016_2022.2$know_account <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_12,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_account)

#"Conoce: Secretario/a" (53)
sjmisc::frq(elsoc_long_2016_2022.2$r01_03)
elsoc_long_2016_2022.2$know_secret <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_03,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_secret)

#"Conoce: Vendedor de tienda o almacen" (43)
sjmisc::frq(elsoc_long_2016_2022.2$r01_05)
elsoc_long_2016_2022.2$know_shopassi <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_05,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_shopassi)

#"Conoce: Parvularia" (43)
sjmisc::frq(elsoc_long_2016_2022.2$r01_09)
elsoc_long_2016_2022.2$know_kinder <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_09,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_kinder)

# Lower status occupations-----------------------------------------------------
#"Conoce: Camarero o mozo" (34)
sjmisc::frq(elsoc_long_2016_2022.2$r01_11)
elsoc_long_2016_2022.2$know_waiter <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_11,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_waiter)

#"Conoce: Mecanico de autos" (34)
sjmisc::frq(elsoc_long_2016_2022.2$r01_04)
elsoc_long_2016_2022.2$know_carmech <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_04,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_carmech)

#"Conoce: Chofer de taxi o colectivo" (30)
sjmisc::frq(elsoc_long_2016_2022.2$r01_10)
elsoc_long_2016_2022.2$know_taxi <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_10,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_taxi)

#"Conoce: Vendedor ambulante" (29)
sjmisc::frq(elsoc_long_2016_2022.2$r01_02)
elsoc_long_2016_2022.2$know_stvend <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_02,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_stvend)

#"Conoce: Aseador/a de oficina" (16)
sjmisc::frq(elsoc_long_2016_2022.2$r01_07)
elsoc_long_2016_2022.2$know_cleaner <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_07,"1=0;2:7=1"))
sjmisc::frq(elsoc_long_2016_2022.2$know_cleaner)

elsoc_long_2016_2022.2 %>% 
  select(starts_with("know_")) %>% 
  names()

# Total of known occupations
n_ocupnames<- names(select(elsoc_long_2016_2022.2,starts_with("know_")))
elsoc_long_2016_2022.2$know_total <- rowSums(x = select(elsoc_long_2016_2022.2,n_ocupnames),na.rm = T)
summary(elsoc_long_2016_2022.2$know_total)
sjlabelled::set_label(elsoc_long_2016_2022.2$know_total) <- 'Total of known occupations'
sjPlot::plot_frq(elsoc_long_2016_2022.2$know_total,type = 'density')

# assing labels
professions <- c("Medical doctor", "Manager of a large firm", "Lawyer",
                "University Professor", "Accountant", "Secretary", "Shop assistant",
                "Preschool teacher", "Waiter", "Car mechanic", "Taxi driver",
                "Street vendor", "Office cleaner","Total")
labels <- paste0("Know: ",professions)
vars_tolabel <- names(select(elsoc_long_2016_2022.2 ,starts_with("know_")))
elsoc_long_2016_2022.2[,c(vars_tolabel)] <- set_label(x = elsoc_long_2016_2022.2[,c(vars_tolabel)],label = labels)
# elsoc_long_2016_2022.2[,c(vars_tolabel)] %>% View
```


```{r status}
# Higher status occupations-----------------------------------------------------
sjmisc::frq(elsoc_long_2016_2022.2$know_doctor)#"Num. Conocidos: Medico o doctor/a" (88)
elsoc_long_2016_2022.2$isei_doctor <- ifelse(elsoc_long_2016_2022.2$know_doctor==1,88,NA)
sjmisc::frq(elsoc_long_2016_2022.2$isei_doctor)

sjmisc::frq(elsoc_long_2016_2022.2$know_ceo) #"Num. Conocidos: Gerente o director de gran empresa" (70)
elsoc_long_2016_2022.2$isei_ceo<- ifelse(elsoc_long_2016_2022.2$know_ceo==1,70,NA) #
sjmisc::frq(elsoc_long_2016_2022.2$isei_ceo)

sjmisc::frq(elsoc_long_2016_2022.2$know_lawyer) #"Num. Conocidos: Abogado/a" (85)
elsoc_long_2016_2022.2$isei_lawyer<- ifelse(elsoc_long_2016_2022.2$know_lawyer==1,70,NA) # #if know, impute 85
sjmisc::frq(elsoc_long_2016_2022.2$isei_lawyer)

sjmisc::frq(elsoc_long_2016_2022.2$know_univprof) #"Num. Conocidos: Profesor/a de universidad" (77)
elsoc_long_2016_2022.2$isei_univprof<- ifelse(elsoc_long_2016_2022.2$know_univprof==1,77,NA) #  #if know, impute 77
sjmisc::frq(elsoc_long_2016_2022.2$isei_univprof)

sjmisc::frq(elsoc_long_2016_2022.2$know_account) #"Num. Conocidos: Contador/a" (69)
elsoc_long_2016_2022.2$isei_account<- ifelse(elsoc_long_2016_2022.2$know_account==1,69,NA) # #if know, impute 60
sjmisc::frq(elsoc_long_2016_2022.2$isei_account)

# Middle status occupations-----------------------------------------------------

sjmisc::frq(elsoc_long_2016_2022.2$know_secret) #"Num. Conocidos: Secretario/a" (53)
elsoc_long_2016_2022.2$isei_secret<- ifelse(elsoc_long_2016_2022.2$know_secret==1,54,NA) # #if know, impute 53
sjmisc::frq(elsoc_long_2016_2022.2$isei_secret)

sjmisc::frq(elsoc_long_2016_2022.2$know_shopassi) #"Num. Conocidos: Vendedor de tienda o almacen" (43)
elsoc_long_2016_2022.2$isei_shopassi<- ifelse(elsoc_long_2016_2022.2$know_shopassi==1,43,NA) # #if know, impute 43
sjmisc::frq(elsoc_long_2016_2022.2$isei_shopassi)

sjmisc::frq(elsoc_long_2016_2022.2$know_kinder) #"Num. Conocidos: Parvularia" (43)
elsoc_long_2016_2022.2$isei_kinder<- ifelse(elsoc_long_2016_2022.2$know_kinder==1,43,NA) # #if know, impute 43
sjmisc::frq(elsoc_long_2016_2022.2$isei_kinder)

# Lower status occupations-----------------------------------------------------
sjmisc::frq(elsoc_long_2016_2022.2$know_waiter) #"Num. Conocidos: Camarero o mozo" (34)
elsoc_long_2016_2022.2$isei_waiter<- ifelse(elsoc_long_2016_2022.2$know_waiter==1,34,NA) #  #if know, impute 34
sjmisc::frq(elsoc_long_2016_2022.2$isei_waiter)

sjmisc::frq(elsoc_long_2016_2022.2$know_carmech)#"Num. Conocidos: Mecanico de autos" (34)
elsoc_long_2016_2022.2$isei_carmech<- ifelse(elsoc_long_2016_2022.2$know_carmech==1,34,NA) # #if know, impute 34
sjmisc::frq(elsoc_long_2016_2022.2$isei_carmech)

sjmisc::frq(elsoc_long_2016_2022.2$know_taxi) #"Num. Conocidos: Chofer de taxi o colectivo" (30)
elsoc_long_2016_2022.2$isei_taxi<- ifelse(elsoc_long_2016_2022.2$know_taxi==1,30,NA) #  #if know, impute 30
sjmisc::frq(elsoc_long_2016_2022.2$isei_taxi)

sjmisc::frq(elsoc_long_2016_2022.2$know_stvend)#"Num. Conocidos: Vendedor ambulante" (29)
elsoc_long_2016_2022.2$isei_stvend<- ifelse(elsoc_long_2016_2022.2$know_stvend==1,29,NA) # #if know, impute 29
sjmisc::frq(elsoc_long_2016_2022.2$isei_stvend)

sjmisc::frq(elsoc_long_2016_2022.2$know_cleaner) #"Num. Conocidos: Aseador/a de oficina" (16)
elsoc_long_2016_2022.2$isei_cleaner<- ifelse(elsoc_long_2016_2022.2$know_cleaner==1,16,NA) # #if know, impute 16
sjmisc::frq(elsoc_long_2016_2022.2$isei_cleaner)

# elsoc %>%
#   select(idencuesta,starts_with("isei_")) %>%
#   View
```

```{r number}
# for the number of contacts for each occupation, the average value is used.

sjmisc::frq(elsoc_long_2016_2022.2$r01_08) #"Num. Conocidos: Medico o doctor/a" 
elsoc_long_2016_2022.2$n_doctor <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_08,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_doctor)
table(elsoc_long_2016_2022.2$n_doctor,elsoc_long_2016_2022.2$ola)


sjmisc::frq(elsoc_long_2016_2022.2$r01_01) #"Num. Conocidos: Gerente o director de gran empresa" (70)
elsoc_long_2016_2022.2$n_ceo <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_01,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_ceo)
table(elsoc_long_2016_2022.2$n_ceo,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_06) #"Num. Conocidos: Abogado/a" (85)
elsoc_long_2016_2022.2$n_lawyer <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_06,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_lawyer)
table(elsoc_long_2016_2022.2$n_lawyer,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_13) #"Num. Conocidos: Profesor/a de universidad" (77)
elsoc_long_2016_2022.2$n_univprof <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_13,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_univprof)
table(elsoc_long_2016_2022.2$n_univprof,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_12)#"Num. Conocidos: Contador/a" (60)
elsoc_long_2016_2022.2$n_account <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_12,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_account)
table(elsoc_long_2016_2022.2$n_account,elsoc_long_2016_2022.2$ola)


# Middle status occupations-----------------------------------------------------
sjmisc::frq(elsoc_long_2016_2022.2$r01_03) #"Num. Conocidos: Secretario/a" (53)
elsoc_long_2016_2022.2$n_secret <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_03,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_secret)
table(elsoc_long_2016_2022.2$n_secret,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_05) #"Num. Conocidos: Vendedor de tienda o almacen" (43)
elsoc_long_2016_2022.2$n_shopassi <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_05,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_shopassi)
table(elsoc_long_2016_2022.2$n_shopassi,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_09) #"Num. Conocidos: Parvularia" (43)
elsoc_long_2016_2022.2$n_kinder <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_09,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_kinder)
table(elsoc_long_2016_2022.2$n_kinder,elsoc_long_2016_2022.2$ola)

# Lower status occupations-----------------------------------------------------
sjmisc::frq(elsoc_long_2016_2022.2$r01_11) #"Num. Conocidos: Camarero o mozo" (34)
elsoc_long_2016_2022.2$n_waiter <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_11,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_waiter)
table(elsoc_long_2016_2022.2$n_waiter,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_04)#"Num. Conocidos: Mecanico de autos" (34)
elsoc_long_2016_2022.2$n_carmech <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_04,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_carmech)
table(elsoc_long_2016_2022.2$n_carmech,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_10) #"Num. Conocidos: Chofer de taxi o colectivo" (30)
elsoc_long_2016_2022.2$n_taxi <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_10,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_taxi)
table(elsoc_long_2016_2022.2$n_taxi,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_02) #"Num. Conocidos: Vendedor ambulante" (29)
elsoc_long_2016_2022.2$n_stvend <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_02,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_stvend)
table(elsoc_long_2016_2022.2$n_stvend,elsoc_long_2016_2022.2$ola)

sjmisc::frq(elsoc_long_2016_2022.2$r01_07) #"Num. Conocidos: Aseador/a de oficina" (17)
elsoc_long_2016_2022.2$n_cleaner <- as.numeric(car::recode(elsoc_long_2016_2022.2$r01_07,"1=0;2=1;3=3;4=6;5=9;6=13;7=17"))
sjmisc::frq(elsoc_long_2016_2022.2$n_cleaner)

table(elsoc_long_2016_2022.2$n_cleaner,elsoc_long_2016_2022.2$ola)

elsoc_long_2016_2022.2 %>% 
  select(starts_with("n_")) %>% 
  names()


# total number of contacts
n_ocupnames<- c("n_doctor","n_ceo","n_lawyer","n_univprof","n_account","n_secret","n_shopassi","n_kinder","n_waiter","n_carmech","n_taxi","n_stvend","n_cleaner")
elsoc_long_2016_2022.2$n_total <- rowSums(x = select(elsoc_long_2016_2022.2,n_ocupnames),na.rm = F)
summary(elsoc_long_2016_2022.2$n_total)
sjlabelled::set_label(elsoc_long_2016_2022.2$n_total) <- 'Total number of contacts'
sjPlot::plot_frq(elsoc_long_2016_2022.2$n_total,type = 'density')
elsoc_long_2016_2022.2 %>%  select(starts_with("n_")) %>% skimr::skim()
# elsoc_long_2016_2022.2 %>%  select(starts_with("n_")) %>% View
# List of variables to divide
variables <- elsoc_long_2016_2022.2 %>% 
  select(starts_with("n_")) %>% 
  names()

# Divide each variable by the divisor and create new variables
for (i in variables) {
  z <- paste0("pct_",i)
  z <- gsub("n_", "", z)
  elsoc_long_2016_2022.2[[z]] <- as.numeric(elsoc_long_2016_2022.2[[i]]/elsoc_long_2016_2022.2$n_total)
}

# assing labels
professions <- c("Medical doctor", "Manager of a large firm", "Lawyer",
                "University Professor", "Accountant", "Secretary", "Shop assistant",
                "Preschool teacher", "Waiter", "Car mechanic", "Taxi driver",
                "Street vendor", "Office cleaner")
labels <- paste0("Percentage of contacts: ",professions)

vars_tolabel <- names(select(elsoc_long_2016_2022.2 ,starts_with("pct_"),-pct_total,-"pct_visitas_entr"))
elsoc_long_2016_2022.2[,c(vars_tolabel)] <- set_label(x = elsoc_long_2016_2022.2[,c(vars_tolabel)],label = labels)
# elsoc[,c(vars_tolabel)] %>% View
```

```{r social-capital}
# Social capital measures
isei_ocupnames<- names(select(elsoc_long_2016_2022.2,starts_with("isei_")))
n_ocupnames <- names(select(elsoc_long_2016_2022.2,starts_with("n_"),-n_total,-"n_visitas_entr"))

# number of high status contacts
elsoc_long_2016_2022.2$num_high <-
  rowSums(x = select(elsoc_long_2016_2022.2,c("n_doctor","n_ceo","n_lawyer", "n_univprof","n_account")),na.rm = T)

elsoc_long_2016_2022.2$n_high <- 
  rowSums(x = select(elsoc_long_2016_2022.2,c("know_doctor","know_ceo","know_lawyer", "know_univprof","know_account")),na.rm = T)
sjlabelled::set_label(elsoc_long_2016_2022.2$n_high) <- 'Number of high status contacts'
sjPlot::plot_frq(elsoc_long_2016_2022.2$n_high,type = 'density')

# percentage of high status contacts
# elsoc_long_2016_2022.2$pct_high <- (elsoc_long_2016_2022.2$n_high/elsoc_long_2016_2022.2$n_total)*100
elsoc_long_2016_2022.2$pct_high <- (elsoc_long_2016_2022.2$n_high/elsoc_long_2016_2022.2$know_total)*100
elsoc_long_2016_2022.2$porc_high <- (elsoc_long_2016_2022.2$num_high/elsoc_long_2016_2022.2$n_total)*100
sjlabelled::set_label(elsoc_long_2016_2022.2$pct_high ) <- 'Percentage of high status contacts'
sjlabelled::set_label(elsoc_long_2016_2022.2$porc_high) <- 'Percentage of high status contacts'
sjPlot::plot_frq(elsoc_long_2016_2022.2$pct_high,type = 'density')

# number of middle status contacts
elsoc_long_2016_2022.2$num_middle <-
  rowSums(x = select(elsoc_long_2016_2022.2,c("n_secret","n_shopassi","n_kinder")),na.rm = T)
elsoc_long_2016_2022.2$n_middle <-
  rowSums(x = select(elsoc_long_2016_2022.2,c("know_secret","know_shopassi","know_kinder")),na.rm = T)
sjlabelled::set_label(elsoc_long_2016_2022.2$n_middle) <- 'Number of middle status contacts'
sjPlot::plot_frq(elsoc_long_2016_2022.2$n_middle,type = 'density')

# percentage of middle status contacts
elsoc_long_2016_2022.2$pct_middle <- (elsoc_long_2016_2022.2$n_middle/elsoc_long_2016_2022.2$know_total)*100
elsoc_long_2016_2022.2$porc_middle <- (elsoc_long_2016_2022.2$num_middle/elsoc_long_2016_2022.2$n_total)*100
sjlabelled::set_label(elsoc_long_2016_2022.2$porc_middle) <- 'Percentage of middle status contacts'
sjlabelled::set_label(elsoc_long_2016_2022.2$pct_middle) <- 'Percentage of middle status contacts'
sjPlot::plot_frq(elsoc_long_2016_2022.2$pct_middle,type = 'density')

# number of low status contacts
elsoc_long_2016_2022.2$num_low <-
  rowSums(x = select(elsoc_long_2016_2022.2,c("n_waiter","n_carmech","n_taxi","n_stvend","n_cleaner")),na.rm = T)
elsoc_long_2016_2022.2$n_low <- 
  rowSums(x = select(elsoc_long_2016_2022.2,c("know_waiter","know_carmech","know_taxi","know_stvend","know_cleaner")),na.rm = T)
sjlabelled::set_label(elsoc_long_2016_2022.2$n_low) <- 'Number of low status contacts'
sjPlot::plot_frq(elsoc_long_2016_2022.2$n_low,type = 'density')
sjPlot::plot_frq(elsoc_long_2016_2022.2$num_low,type = 'density')

# percentage of low status contacts
elsoc_long_2016_2022.2$porc_low <- (elsoc_long_2016_2022.2$num_low/elsoc_long_2016_2022.2$n_total)*100
sjlabelled::set_label(elsoc_long_2016_2022.2$porc_low) <- 'Percentage of low status contacts'

elsoc_long_2016_2022.2$pct_low <- (elsoc_long_2016_2022.2$n_low/elsoc_long_2016_2022.2$know_total)*100
sjlabelled::set_label(elsoc_long_2016_2022.2$pct_low) <- 'Percentage of low status contacts'
sjPlot::plot_frq(elsoc_long_2016_2022.2$pct_low,type = 'density')
sjPlot::plot_frq(elsoc_long_2016_2022.2$porc_low,type = 'density')

# Average ISEI 
elsoc_long_2016_2022.2$isei_avg <- rowMeans(x = select(elsoc_long_2016_2022.2,isei_ocupnames),na.rm = T)
sjlabelled::set_label(elsoc_long_2016_2022.2$isei_avg) <- 'Average contact prestige'
skimr::skim(elsoc_long_2016_2022.2$isei_avg)
sjPlot::plot_frq(elsoc_long_2016_2022.2$isei_avg,type = 'density')

# Total ISEI 
elsoc_long_2016_2022.2$isei_tot <- rowSums(x = select(elsoc_long_2016_2022.2,isei_ocupnames),na.rm = T)
sjlabelled::set_label(elsoc_long_2016_2022.2$isei_tot) <- 'Total contact prestige'
sjmisc::frq(elsoc_long_2016_2022.2$isei_avg)
sjPlot::plot_frq(elsoc_long_2016_2022.2$isei_avg,type = 'density')

# skimr::skim(elsoc_long_2016_2022.2$isei_tot/elsoc_long_2016_2022.2$n_total)
# skimr::skim(elsoc_long_2016_2022.2$isei_tot/elsoc_long_2016_2022.2$know_total)
# skimr::skim(elsoc_long_2016_2022.2$isei_avg)


# max ISEI 
elsoc_long_2016_2022.2 <- elsoc_long_2016_2022.2 %>% 
mutate(isei_max = do.call(pmax, c(select(., isei_ocupnames), na.rm = TRUE)))
sjlabelled::set_label(elsoc_long_2016_2022.2$isei_max) <- 'Maximum contact prestige'
sjmisc::frq(elsoc_long_2016_2022.2$isei_max)
sjPlot::plot_frq(elsoc_long_2016_2022.2$isei_max)

# min ISEI
elsoc_long_2016_2022.2 <- elsoc_long_2016_2022.2 %>% 
mutate(isei_min = do.call(pmin, c(select(., isei_ocupnames), na.rm = TRUE)))
sjlabelled::set_label(elsoc_long_2016_2022.2$isei_min) <- 'Minimum contact prestige'
sjmisc::frq(elsoc_long_2016_2022.2$isei_min)
sjPlot::plot_frq(elsoc_long_2016_2022.2$isei_min)

# range ISEI
table(elsoc_long_2016_2022.2$know_total>=2)
elsoc_long_2016_2022.2$isei_range <- ifelse(elsoc_long_2016_2022.2$know_total>=2,(elsoc_long_2016_2022.2$isei_max - elsoc_long_2016_2022.2$isei_min),no = NA)

sjlabelled::set_label(elsoc_long_2016_2022.2$isei_range) <- 'Range contact prestige'
sjmisc::frq(elsoc_long_2016_2022.2$isei_range)
# sjPlot::plot_frq(elsoc_long_2016_2022.2$isei_range)
elsoc_long_2016_2022.2 %>% select(starts_with("isei_")) %>% View

# ggpairs(elsoc_long_2016_2022.2[,c("isei_avg","isei_max","isei_range",
#                  "n_total","n_high","n_middle","n_low",
#                  "pct_high","pct_middle","pct_low")], 
#         title="Social capital measures") 
```

```{r}
## Heterogeneidad de la RED ------------------------------------------------
##Ocupaciones
# calculate the proportion for each occupation and then apply a cuadratic term
elsoc_long_2016_2022.2$prop_doctor<-((elsoc_long_2016_2022.2$n_doctor/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_ceo<-((elsoc_long_2016_2022.2$n_ceo/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_lawyer<-((elsoc_long_2016_2022.2$n_lawyer/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_univprof<-((elsoc_long_2016_2022.2$n_univprof/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_account<-((elsoc_long_2016_2022.2$n_account/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_secret<-((elsoc_long_2016_2022.2$n_secret/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_shopassi<-((elsoc_long_2016_2022.2$n_shopassi/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_kinder<-((elsoc_long_2016_2022.2$n_kinder/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_waiter<-((elsoc_long_2016_2022.2$n_waiter/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_carmech<-((elsoc_long_2016_2022.2$n_carmech/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_taxi<-((elsoc_long_2016_2022.2$n_taxi/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_stvend<-((elsoc_long_2016_2022.2$n_stvend/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_cleaner<-((elsoc_long_2016_2022.2$n_cleaner/elsoc_long_2016_2022.2$n_total))^2

prop_ocup <- 
c("prop_doctor","prop_ceo","prop_lawyer","prop_univprof","prop_account",
"prop_secret","prop_shopassi","prop_kinder","prop_waiter","prop_carmech",
"prop_taxi","prop_stvend","prop_cleaner")

elsoc_long_2016_2022.2$diversity=1-rowSums(elsoc_long_2016_2022.2[,prop_ocup])
sjlabelled::set_label(elsoc_long_2016_2022.2$diversity) <- "Network diversity (D-Simpson)"

elsoc_long_2016_2022.2$homogeneity=rowSums(elsoc_long_2016_2022.2[,prop_ocup])
sjlabelled::set_label(elsoc_long_2016_2022.2$homogeneity) <- "Network Homogeneity (D-Simpson)"


elsoc_long_2016_2022.2$prop_upper<-((elsoc_long_2016_2022.2$n_high/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_interm<-((elsoc_long_2016_2022.2$n_middle/elsoc_long_2016_2022.2$n_total))^2
elsoc_long_2016_2022.2$prop_working<-((elsoc_long_2016_2022.2$n_low/elsoc_long_2016_2022.2$n_total))^2

elsoc_long_2016_2022.2$diversityclass=1-rowSums(elsoc_long_2016_2022.2[,c("prop_upper","prop_interm","prop_working")])


```



```{r}
bind_rows(
elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(isei_avg=mean(isei_avg,na.rm = T),
         field="Network average ISEI"),
) %>% na.omit() %>% 
  ggplot(aes(x=factor(ola),y = isei_avg, group=field, color=field,label=round(isei_avg,2))) +
  geom_point()+
  geom_line() +
  geom_label()+
  scale_y_continuous(limits = c(16,88)) +
  scale_x_discrete(labels=c("2016","2017","2021")) +
  labs(title = "Network average ISEI by year",x="Year",y=NULL)

elsoc_long_2016_2022.2 %>% 
  ggplot(aes(x=factor(ola),y = isei_avg)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(labels=c("2016","2017","2018","2019","2021","2022")) +
  labs(title = "Network average ISEI by year",x="Year",y=NULL)


elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(n_total=mean(n_total,na.rm = T),
         field="Total number of contacts") %>%
  filter(n_total>0) %>% 
  na.omit() %>% 
  ggplot(aes(x=factor(ola),y = n_total, group=field,label=round(n_total,2))) +
  geom_point()+
  geom_line() +
  geom_label()+
  scale_y_continuous(limits = c(0,221)) +
  scale_x_discrete(labels=c("2016","2017","2021")) +
  labs(title = "Network total contacts by year",x="Year",y=NULL)

elsoc_long_2016_2022.2 %>% 
  ggplot(aes(x=factor(ola),y = n_total)) +
  geom_boxplot() +
  # scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(labels=c("2016","2017","2018","2019","2021","2022")) +
  labs(title = "Network total contacts by year",x="Year",y=NULL)
elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(isei_range=mean(isei_range,na.rm = T),field="Network ISEI range") %>% 
    na.omit() %>% 
  ggplot(aes(x=factor(ola),y = isei_range, group=field, color=field)) +
  geom_point()+
  geom_line() +
  scale_y_continuous(limits = c(0,72)) +
  scale_x_discrete(labels=c("2016","2017","2021")) +
  labs(title = "Network ISEI range by year",x="Year",y=NULL)

bind_rows(
elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(perc=mean(porc_high,na.rm = T),Status="high-status"),
elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(perc=mean(porc_middle,na.rm = T),Status="middle-status"),
elsoc_long_2016_2022.2 %>%
  group_by(ola) %>% 
  summarise(perc=mean(porc_low,na.rm = T),Status="low-status")
) %>% 
  na.omit() %>% 
  ggplot(aes(x=factor(ola),y = perc, group=Status, color=Status)) +
  geom_point()+
  geom_line() +
  scale_y_continuous(limits = c(10,90),n.breaks = 20) +
  scale_x_discrete(labels=c("2016","2018","2021")) +
  labs(title = "Network percentage of high, middle and low occupations by year",x="Year",y=NULL) +
  theme()


```


```{r}
# Socioeconomic_________________________________________________________________

# Education_______________________________________
elsoc_long_2016_2022.2$educ <- 
  car::recode(elsoc_long_2016_2022.2$m01,
              "c(1,2,3)=1;c(4,5)=2;c(6,7)=3;c(8,9,10)=4; c(-888,-999)=NA")
elsoc_long_2016_2022.2$educ <-
  factor(elsoc_long_2016_2022.2$educ,
         labels = c("Primary","High school","Technical","Universitary"))

#reverse education, reference level is the highest level
#elsoc_long_2016_2022.2$educ <- forcats::fct_rev(elsoc_long_2016_2022.2$educ)

elsoc_long_2016_2022.2$educ <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$educ,
                      label = "Education")
sjmisc::frq(elsoc_long_2016_2022.2$educ)

#Recoding of education to years based on casen 2017.
elsoc_long_2016_2022.2$educyear<- as.numeric(
  car::recode(elsoc_long_2016_2022.2$m01, 
              "1=0;2=4.3;3=7.5;4=9.8;5=12.02;6=13.9;
               7=14.8;8=14.9;9=16.9;10=19.07;c(-888,-999)=NA", 
              as.numeric = T))

elsoc_long_2016_2022.2$educyear <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$educyear,
                      label = "Education in years")

class(elsoc_long_2016_2022.2$educyear)
sjmisc::frq(elsoc_long_2016_2022.2$educyear)

# Household income_________________________________________

#Impute midpoint of income ranges
elsoc_long_2016_2022.2$m30_rec <-
as.numeric(car::recode(elsoc_long_2016_2022.2$m30,
           "1=110000;2=251000;3=305000;4=355000;5=400000;
            6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
            13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
            19=2275000;20=2700000;NA=NA;c(-888,-999)=NA"))

#Impute midpoint of income ranges (2021)
elsoc_long_2016_2022.2$m30b_rec <-
as.numeric(car::recode(elsoc_long_2016_2022.2$m30b,
           "1=125000;2=300000;3=400000;4=575000;5=70000;NA=NA;c(-888,-999)=NA"))

sjmisc::frq(elsoc_long_2016_2022.2$m30b_rec)

#Recode DK/DA of Income to NA
elsoc_long_2016_2022.2$m29_rec <-
  as.numeric(car::recode(elsoc_long_2016_2022.2$m29,"c(-888,-999)=NA"))

#replace NA of income with new imputed variable
elsoc_long_2016_2022.2$m29_imp <- 
  ifelse(test = !is.na(elsoc_long_2016_2022.2$m29_rec),
         yes =  elsoc_long_2016_2022.2$m29_rec,
         no =  elsoc_long_2016_2022.2$m30_rec)
summary(elsoc_long_2016_2022.2$m29_imp)

elsoc_long_2016_2022.2$m29_imp <- 
  ifelse(test = is.na(elsoc_long_2016_2022.2$m29_imp),
         yes =  elsoc_long_2016_2022.2$m30b_rec,
         no =  elsoc_long_2016_2022.2$m29_imp)
summary(elsoc_long_2016_2022.2$m29_imp)

# deflate at each year's prices
elsoc_long_2016_2022.2$deflactor <-
  with(elsoc_long_2016_2022.2, case_when(
    ola == 2016 ~ 113.88 / 123.82,
    ola == 2017 ~ 116.46 / 123.82,
    ola == 2018 ~ 119.45 / 123.82,
    ola == 2019 ~ 123.82 / 123.82
  ))

# N Household:
elsoc_long_2016_2022.2 <-
  elsoc_long_2016_2022.2 %>%
  mutate(n_hogar =
           dplyr::case_when(ola == 1 ~ nhogar1,
                            ola == 2 ~ m46_nhogar,
                            ola == 3 ~ m54,
                            ola == 4 ~ m54,
                            ola == 5 ~ m54))
sjmisc::frq(elsoc_long_2016_2022.2$n_hogar)

#Recode DK/DA to NA
elsoc_long_2016_2022.2$n_hogar_r<-
  car::recode(elsoc_long_2016_2022.2$n_hogar,"c(-888,-999)=NA")

# Per capita household income:
elsoc_long_2016_2022.2$ing_pc <- 
  (elsoc_long_2016_2022.2$m29_imp/elsoc_long_2016_2022.2$n_hogar_r)

elsoc_long_2016_2022.2$ing_pc <-
sjlabelled::set_label(x = elsoc_long_2016_2022.2$ing_pc,
                      label = "Household income per capita")  

sjmisc::descr(elsoc_long_2016_2022.2$ing_pc)

# Compute income quintiles
elsoc_long_2016_2022.2 <- elsoc_long_2016_2022.2 %>% 
  group_by(ola) %>% 
  mutate(quintil = ntile(-desc(ing_pc), 5)) %>% 
  ungroup()

elsoc_long_2016_2022.2$quintil <- 
  factor(elsoc_long_2016_2022.2$quintil,
         levels = c(1, 2, 3, 4, 5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5')) # Quintiles as factors

#reverse quintile, reference level is the highest quintile
#elsoc_long_2016_2022.2$quintil <- forcats::fct_rev(elsoc_long_2016_2022.2$quintil)

elsoc_long_2016_2022.2$quintil <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$quintil,
                      label = "Household income quintile per capita")  

sjmisc::frq(elsoc_long_2016_2022.2$quintil)

#include new quintile category with missing cases
elsoc_long_2016_2022.2$quintil1<-
  car::recode(elsoc_long_2016_2022.2$quintil, 
              "'Q1'='Q1';'Q2'= 'Q2';'Q3'='Q3';'Q4'='Q4';'Q5'='Q5'; NA='QNA'")

#elsoc_long_2016_2022.2$quintil1 <- factor(elsoc_long_2016_2022.2$quintil1, c("Q1","Q2","Q3","Q4","Q5","QNA"))

elsoc_long_2016_2022.2$quintil1 <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$quintil1,
                      label = "Household income quintile per capita (NA)") 
sjmisc::frq(elsoc_long_2016_2022.2$quintil1)


#Age Ranges
elsoc_long_2016_2022.2$edad <- 
  factor(car::recode(elsoc_long_2016_2022.2$m0_edad, 
                     "18:29=1;30:49=2;50:64=3;65:150=4"),
         labels = c('18-29', '30-49', '50-64', '65 or more'))
elsoc_long_2016_2022.2$edad <-
  sjlabelled::set_label(elsoc_long_2016_2022.2$edad, 
                        label = c("Age groups")) 
# Other controls______________________________________________________________
# Subjective social status: individual ____________________________

elsoc_long_2016_2022.2$ess <- 
as.numeric(elsoc_long_2016_2022.2$d01_01)
sjmisc::frq(elsoc_long_2016_2022.2$ess)
#elsoc_long_2016_2022.2$ess <- sjmisc::rec(elsoc_long_2016_2022.2$ess,rec = "rev")
#sjmisc::frq(elsoc_long_2016_2022.2$ess)

elsoc_long_2016_2022.2$ess <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$ess,
                      label = "Subjective Social Status: individual")


sjmisc::frq(elsoc_long_2016_2022.2$ess)
# sjPlot::plot_frq(elsoc_long_2016_2022.2$ess)

# Political position ____________________________
elsoc_long_2016_2022.2$pos_id <-
factor(
  car::recode(
    elsoc_long_2016_2022.2$c15,
    "c(11,12,-888,-999)='Does not identify';c(0,1,2,3,4)='Left';
     c(5)='Center';c(6,7,8,9,10)='Right'"
  ),
  levels = c('Left', 'Center', 'Right', 'Does not identify')
)

elsoc_long_2016_2022.2$pos_id <- factor(elsoc_long_2016_2022.2$pos_id,
                                      levels = levels(elsoc_long_2016_2022.2$pos_id))

elsoc_long_2016_2022.2$pos_id <- 
sjlabelled::set_label(x = elsoc_long_2016_2022.2$pos_id, 
                      label = "Political identification") 

sjmisc::frq(elsoc_long_2016_2022.2$pos_id)
```

```{r}
elsoc_long_2016_2022.2 %>% 
  select(isei_avg,porc_low,porc_middle,porc_high,just_educ,just_salud,just_pension) %>% 
  sjPlot::tab_corr(triangle = "lower",wrap.labels =25,
                   var.labels = c("ISEI network","Low-status ties %"," Middle-status ties %"," High-status ties % ","Education","Health","Pensions"),digits = 2)

elsoc_long_2016_2022.2 %>%
  filter(ola %in% c(1)) %>%
  select(isei_avg,diversity,diversityclass,porc_low,porc_middle,porc_high,
         # percgerlog,percobrlog,
         # justger,justobr,
         percgaplog,
         percgapptile,
         justgaplog,
         justgapptile
         ) %>% 
  sjPlot::tab_corr(triangle = "lower")

dfreg <- 
elsoc_long_2016_2022.2 %>%
  filter(ola %in%c(1,3,5))
  
dfreg <- 
dfreg %>% select(idencuesta,ola,
                 # just_educ,just_salud,just_pension,
                 justgapptile,
                 percgapptile,
                 porc_high,porc_low,
                 isei_avg,n_total,
                 diversity,diversityclass,educyear,quintil1) %>% 
  arrange(idencuesta)






df_filter<- data.frame(frq(dfreg$idencuesta)) %>% select(idencuesta=val,frq)
df_filter$keep <- df_filter$frq>=3
table(df_filter$keep)
# 
dfreg <-  dfreg %>% left_join(df_filter,by = "idencuesta")
dfreg <-  dfreg %>%  filter(keep=="TRUE")
table(dfreg$keep)

df_filter<- data.frame(frq(dfreg$idencuesta)) %>% select(idencuesta=val,frq)
df_filter$keep <- df_filter$frq>=3
table(df_filter$keep)
dim(dfreg)

education <- 
list(
  # lme4::lmer(just_educ~porc_low +(1|idencuesta),data = dfreg),
  # lme4::lmer(just_educ~ porc_middle + (1|idencuesta),data = dfreg),
  # lme4::lmer(just_educ~porc_high +(1|idencuesta),data = dfreg),
  lme4::lmer(just_educ~porc_low + porc_high +(1|idencuesta),data = dfreg),
  # lme4::lmer(just_educ~porc_low + porc_high + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(just_educ~isei_avg + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(just_educ~isei_avg + diversity + n_total +ola + educyear + quintil1 + (1+educyear|idencuesta),data = dfreg),
  lme4::lmer(just_educ~isei_avg + diversityclass + n_total + ola + educyear + quintil1 + (1|idencuesta),data = dfreg)
)

texreg::screenreg(education)

health <- 
list(
  # lme4::lmer(just_salud~porc_low +(1|idencuesta),data = dfreg),
  # lme4::lmer(just_salud~ porc_middle + (1|idencuesta),data = dfreg),
  # lme4::lmer(just_salud~porc_high +(1|idencuesta),data = dfreg),
  lme4::lmer(just_salud~porc_low + porc_high +(1|idencuesta),data = dfreg),
  lme4::lmer(just_salud~porc_low + porc_high + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(just_salud~isei_avg + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(just_salud~isei_avg + diversity + n_total +ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
     lme4::lmer(just_salud~isei_avg + diversityclass + n_total + ola + educyear + quintil1 + (1|idencuesta),data = dfreg)
)

texreg::screenreg(health)

pensions <- 
list(
  # lme4::lmer(just_pension~porc_low +(1|idencuesta),data = dfreg),
  # lme4::lmer(just_pension~ porc_middle + (1|idencuesta),data = dfreg),
  # lme4::lmer(just_pension~porc_high +(1|idencuesta),data = dfreg),
  # lme4::lmer(just_pension~porc_low + porc_middle +porc_high +(1|idencuesta),data = dfreg),
  lme4::lmer(just_pension~porc_low + porc_high + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(just_pension~isei_avg + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(just_pension~isei_avg + diversity + n_total +ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
     lme4::lmer(just_pension~isei_avg + diversityclass + n_total + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
     lme4::lmer(just_pension~isei_avg + diversityclass + n_total + ola + educyear + quintil1 + (1|idencuesta),data = dfreg)
)

texreg::screenreg(pensions)

salarygaps <- 
list(
  # lme4::lmer(just_pension~porc_low +(1|idencuesta),data = dfreg),
  # lme4::lmer(just_pension~ porc_middle + (1|idencuesta),data = dfreg),
  # lme4::lmer(just_pension~porc_high +(1|idencuesta),data = dfreg),
  # lme4::lmer(just_pension~porc_low + porc_middle +porc_high +(1|idencuesta),data = dfreg),
  lme4::lmer(justgapptile~porc_low + porc_high + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(justgapptile~isei_avg + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
  lme4::lmer(justgapptile~isei_avg + diversity + n_total +ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
     lme4::lmer(justgapptile~isei_avg + diversityclass + n_total + ola + educyear + quintil1 + (1|idencuesta),data = dfreg),
     lme4::lmer(justgapptile~isei_avg + diversityclass + n_total + ola + educyear + quintil1 + (1|idencuesta),data = dfreg)
)

texreg::screenreg(salarygaps)







```



```{r}
# Select variables______________________________________________________________

df_study1 <- 
elsoc_long_2016_2022.2 %>% 
  filter(muestra == 1) %>% #keep original sample (vs refresh)
  select(idencuesta,ola,region,region_cod,comuna,comunacod=comuna_cod,
         muestra,
         ponderador_long_total, segmento, estrato,
         sexo,
         # cuestion_mig,
         # starts_with("in_"),
         just_educ,
         just_pension,
         just_salud,
         des_perc,
         merit_effort,
         merit_talent,
         ahead_family,
         ahead_educ,
         ahead_ambition,
         ahead_hardwork,
         educ,educyear,
         # ing_pc,
         # quintil,
         quintil1,
         ess,
         # ess_inm,
         # nation_t1,
         # know_inm,
         # know_inm_bi,
         # frien_inm_bi_t4,
         # frien_inm_bi_t1,
         # know_inm_t1t4,
         # frien_inm,
         # frien_inm_bi,
         # frien_inm_t1t4,
         pos_id,
         edad)


# Reshape long to wide
df_study1_wide <- df_study1 %>% 
  tidyr::pivot_wider(id_cols = c("idencuesta","muestra"),
                     names_from = "ola",
                     # names_prefix = c("educ","educyear","ing_pc","quintil","quintil1"),
                     values_from = names(select(df_study1,comuna,comunacod,ponderador_long_total,segmento, estrato, just_educ:edad,sexo))
                     )

# fix data to w01 values
df_study1_wide$edad_2 <-df_study1_wide$edad_1 #age
df_study1_wide$edad_3 <-df_study1_wide$edad_1
df_study1_wide$edad_4 <-df_study1_wide$edad_1
df_study1_wide$edad_5 <-df_study1_wide$edad_1
df_study1_wide$edad_6 <-df_study1_wide$edad_1

df_study1_wide$sexo_2 <-df_study1_wide$sexo_1 #sex
df_study1_wide$sexo_3 <-df_study1_wide$sexo_1
df_study1_wide$sexo_4 <-df_study1_wide$sexo_1
df_study1_wide$sexo_5 <-df_study1_wide$sexo_1
df_study1_wide$sexo_6 <-df_study1_wide$sexo_1

df_study1_wide$educ_2 <-df_study1_wide$educ_1 #education
df_study1_wide$educ_3 <-df_study1_wide$educ_1
df_study1_wide$educ_4 <-df_study1_wide$educ_1
df_study1_wide$educ_5 <-df_study1_wide$educ_1
df_study1_wide$educ_6 <-df_study1_wide$educ_1

df_study1_wide$educyear_2 <-df_study1_wide$educyear_1 #education years
df_study1_wide$educyear_3 <-df_study1_wide$educyear_1
df_study1_wide$educyear_4 <-df_study1_wide$educyear_1
df_study1_wide$educyear_5 <-df_study1_wide$educyear_1
df_study1_wide$educyear_6 <-df_study1_wide$educyear_1

df_study1_wide$quintil1_2 <-df_study1_wide$quintil1_1 #quintiles
df_study1_wide$quintil1_3 <-df_study1_wide$quintil1_1
df_study1_wide$quintil1_4 <-df_study1_wide$quintil1_1
df_study1_wide$quintil1_5 <-df_study1_wide$quintil1_1
df_study1_wide$quintil1_6 <-df_study1_wide$quintil1_1

df_study1_wide$ess_2 <-df_study1_wide$ess_1 # subjective status
df_study1_wide$ess_3 <-df_study1_wide$ess_1
df_study1_wide$ess_4 <-df_study1_wide$ess_1
df_study1_wide$ess_5 <-df_study1_wide$ess_1
df_study1_wide$ess_6 <-df_study1_wide$ess_1

df_study1_wide$pos_id_2 <-df_study1_wide$pos_id_1 # political position
df_study1_wide$pos_id_3 <-df_study1_wide$pos_id_1
df_study1_wide$pos_id_4 <-df_study1_wide$pos_id_1
df_study1_wide$pos_id_5 <-df_study1_wide$pos_id_1
df_study1_wide$pos_id_6 <-df_study1_wide$pos_id_1

df_study1_wide$comuna_2 <-df_study1_wide$comuna_1 #comuna
df_study1_wide$comuna_3 <-df_study1_wide$comuna_1
df_study1_wide$comuna_4 <-df_study1_wide$comuna_1
df_study1_wide$comuna_5 <-df_study1_wide$comuna_1
df_study1_wide$comuna_6 <-df_study1_wide$comuna_1

df_study1_wide$comunacod_2 <-df_study1_wide$comunacod_1 #comuna
df_study1_wide$comunacod_3 <-df_study1_wide$comunacod_1
df_study1_wide$comunacod_4 <-df_study1_wide$comunacod_1
df_study1_wide$comunacod_5 <-df_study1_wide$comunacod_1
df_study1_wide$comunacod_6 <-df_study1_wide$comunacod_1

dim(df_study1_wide)

sjPlot::view_df(df_study1_wide,
                show.frq = T,show.values = T,show.na = T,show.prc = T, show.type = T)


# reshape from long to wide
pacman::p_load(datasets,data.table)
df_study1_long <- data.table::melt.data.table(data.table::setDT(df_study1_wide),
              id.vars = c("idencuesta","muestra"),
              variable.name = c("ola"),
              measure = patterns("^comuna_","^comunacod_","^ponderador_long_total", "^segmento", "^estrato",
                                 "^just_educ_", "^just_pension_", "^just_salud_", "^des_perc_",
                                 "^merit_effort_","^merit_talent_",
                                 "^ahead_family_", "^ahead_educ_", "^ahead_ambition_", "^ahead_hardwork_",
                                 "^educ_","^educyear_","^quintil1_","^ess_",
                                 "^pos_id_",
                                 "^edad_","^sexo_"
                                 ),
              value.name = c("comuna","comunacod","ponderador_long_total","segmento","estrato",
                             "just_educ", "just_pension","just_salud", "des_perc",
                             "merit_effort","merit_talent",
                             "ahead_family","ahead_educ","ahead_ambition","ahead_hardwork",
                             "educ","educyear","quintil1","ess",
                             "pos_id",
                             "edad","sexo"),
              na.rm = F,value.factor = TRUE
              )

names(df_study1_long) #check names of long dataset
dim(df_study1_long) #check dimensions of the dataframe
# Original dataset with 6 waves
df_study2_long <- df_study1_long

# filter the dataset for the waves 1 to 4 and 6
df_study1_long <-
df_study1_long %>% 
  filter(ola %in% c(1,2,3,4,6)) %>% 
  mutate(ola=factor(ola,levels = 1:6,labels = 1:6))
dim(df_study1_long) #check, now is OK

df_study1_long <- 
set_label(x = df_study1_long,
          label = get_label(select(df_study1,names(df_study1_long))))
  

sjPlot::view_df(df_study1_long,
                show.frq = T,show.values = T,show.na = T,show.prc = T,
                show.type = T)
#______________________________________________________________________________
# obtain the idencuesta for wave 6
ids <- 
  df_study1 %>% 
  select(idencuesta,ola) %>% 
  filter(ola==6) %>% 
  sjmisc::frq(idencuesta,show.na = F) %>% as.data.frame()


# filter data by the idencuesta of t5
df_study1_long_t6 <- 
  df_study1_long %>%
  filter(idencuesta %in% ids$val)

names(df_study1_long_t6)
dim(df_study1_long_t6)
sjmisc::frq(df_study1_long_t6$ola)

# SAVE DATA____________________________________________________________________
save(df_study1_long,file = here::here("input/data-proc/df_study1_long.RData"))
save(df_study1_long_t6,file = here::here("input/data-proc/df_study1_long_t6.RData"))
save(df_study2_long,file = here::here("input/data-proc/df_study2_long.RData"))
# save codebook
sjPlot::view_df(df_study1_long,
        show.frq = T,
        show.prc = T,
        show.na = T,
        file = here::here("output/df_study1_long.html"))

sjPlot::view_df(df_study1_long_t6,
        show.frq = T,
        show.prc = T,
        show.na = T,
        file = here::here("output/df_study1_long_t6.html"))
```
```


```{r}


## Contextual data

Notas de Trabajo de campo:

* CENSO 2017, da 19 de abril de 2017. (pegar a 2016)
* CASEN 2017, 2 Noviembre 2017  4 Febrero 2018. (pegar a 2017)
* CASEN 2020, 31 de octubre 2020  04 de febrero 2021. (pegar a 2020)

* Faltaran datos 2019 para algunas comunas 


![](https://radiografia-cambio-social-2016-2021.netlify.app/reporte-elsoc_files/figure-html/amen1-wave-1.png)  
  
```{r}
remove(list = ls()) # clean workspace
# .rs.restartR() #restart R session
if (!require("pacman")) install.packages("pacman") # install pacman
# load libraries
pacman::p_load(dplyr,readxl,sjmisc, sjlabelled, questionr, car,here)
load(here::here("input/data-original/cit17.Rdata"))
load(here::here("input/data-original/cit18.Rdata"))
load(here::here("input/data-original/cit19.Rdata"))
load(here::here("input/data-original/casen2017.Rdata"))
load(here::here("input/data-original/casen2022.Rdata"))
#load(here::here("input/data-original/censo17.Rdata"))
load(here::here("input/data-original/elsoc_long.Rdata"))

df_ine <- 
readxl::read_excel("input/data-original/data_comunas_ine_dem.xlsx")
df_ine$comuna_lc <- tolower(df_ine$comuna)

df_pro_ine <- 
readxl::read_excel("input/data-original/estimaciones-y-proyecciones-2002-2035-comunas.xlsx")
names(df_pro_ine)
df_proye <- 
df_pro_ine %>% 
  select(comuna_cod=Comuna,comuna_nom=`Nombre Comuna`,
         "sexo"=Sexo_1_Hombre_2_Mujer,
         "edad"=Edad,
         pob_17=`Poblacion 2017`,
         pob_18=`Poblacion 2018`,
         pob_19=`Poblacion 2019`,
         pob_20=`Poblacion 2020`)
names(df_proye)

# calculate population proyections 
df_proye_comunas <- 
df_proye %>% 
  group_by(comuna_cod, comuna_nom) %>% 
  summarise(pob_17=sum(pob_17),
            pob_18=sum(pob_18),
            pob_19=sum(pob_19),
            pob_20=sum(pob_20))

df_proye_comunas <-
df_proye_comunas %>% 
  mutate(pob_total_17=sum(df_proye_comunas$pob_17),
         pob_total_18=sum(df_proye_comunas$pob_18),
         pob_total_19=sum(df_proye_comunas$pob_19),
         pob_total_20=sum(df_proye_comunas$pob_20))
names(df_proye_comunas)
# ELSOC long data ____________________________________________________________
df_elsoc <- 
elsoc_long_2016_2022.2 %>% 
  select(comuna,comuna_cod) %>%
  mutate(comuna_lc=tolower(comuna)) %>% 
  group_by(comuna,comuna_lc,comuna_cod) %>% 
  summarise(n_elsoc=n())

df_a <- full_join(df_elsoc,df_ine, by = "comuna_lc", suffix = c("_elsoc","_ine"))
summary(df_a)

# ELSOC CIT - territorial data _________________________________________________
df_17 <- 
cit17 %>% 
  select(idencuesta,escolaridad)

df_18 <- 
cit18 %>% 
  select(idencuesta,escolaridad)

df_19 <- 
cit19 %>% 
  select(idencuesta,escolaridad)
df_19[df_19==-995] <- NA

# create data set
df_cit_a <- 
elsoc_long_2016_2022.2 %>% 
  select(comuna,comuna_cod,idencuesta) %>% 
  left_join(x = .,y = df_19, by ="idencuesta") %>% 
  select(-idencuesta)

df_cit_a <- df_cit_a %>%
  mutate(comuna = ifelse(test = comuna=="unoa",
                         yes = "Nhunhoa",
                         no =  comuna))

df_cit_a <- df_cit_a %>%
  mutate(comuna = ifelse(test = comuna=="Vicuna",
                         yes = "Vicunha",
                         no =  comuna))

df_cit_a <- df_cit_a %>%
  mutate(comuna = ifelse(test = comuna=="Vina del mar",
                         yes = "Vinha del mar",
                         no =  comuna))

df_cit_a <- df_cit_a %>%
  mutate(comuna = ifelse(test = comuna=="Donihue",
                         yes = "Donhihue",
                         no =  comuna))

df_cit_a <- df_cit_a %>%
  mutate(comuna = ifelse(test = comuna=="Penaflor",
                         yes = "Penhaflor",
                         no =  comuna))
df_cit_a <- df_cit_a %>%
  mutate(comuna = ifelse(test = comuna=="Penalolen",
                         yes = "Penhalolen",
                         no =  comuna))


#check for duplicates
df_cit_b <- 
  df_cit_a %>% distinct() %>% arrange(comuna_cod, escolaridad)

#generate final dataset
df_cit <- 
  df_cit_b %>% 
  group_by(comuna, comuna_cod) %>% 
  summarise(esc_cit17=mean(escolaridad,na.rm = T))
  
sjmisc::frq(df_cit$esc_cit17)

# Select and organize variables________________________________________________
df_study1_comunas <- 
df_cit %>%
  mutate(comuna=sjlabelled::as_character(comuna_cod)) %>% 
  dplyr::select(comuna,
                comunacod=comuna_cod,
                esc_cit17
                )
# names(df_study1_comunas)

# Label data____________________________________________________________________
sjlabelled::set_label(df_study1_comunas) <- 
c("Comuna",
  "Codigo Comuna",
  "Escolarity average - CIT 2017 - Municipality (using census tract)"
)

# save data____________________________________________________________________
save(df_study1_comunas,file = here::here("input/data-proc/study_1_comunas.RData"))

# save codebook
sjPlot::view_df(df_study1_comunas,
        show.frq = T, 
        show.prc = T, 
        show.na = T,
        file = here::here("output/df_study1_comunas.html"))
```

